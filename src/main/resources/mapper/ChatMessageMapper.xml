<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xm.game9.mapper.ChatMessageMapper">
    
    <!-- 获取聊天消息列表 -->
    <select id="getChatMessageList" resultType="com.xm.game9.model.vo.ChatMessageVO">
        SELECT 
            cm.messageId,
            cm.senderId,
            u.userNickname as senderNickname,
            u.userAvatar as senderAvatar,
            cm.receiverId,
            cm.content,
            cm.messageType,
            cm.messageStatus as status,
            cm.createTime as createTime
        FROM chat_message cm
        LEFT JOIN user u ON cm.senderId = u.userId
        WHERE cm.isDeleted = 0
        AND ((cm.senderId = #{userId} AND cm.receiverId = #{friendId})
             OR (cm.senderId = #{friendId} AND cm.receiverId = #{userId}))
        ORDER BY cm.createTime DESC
    </select>
    
    <!-- 获取未读消息数量 -->
    <select id="getUnreadCount" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM chat_message
        WHERE receiverId = #{userId}
        AND messageStatus = 0
        AND isDeleted = 0
    </select>
    
    <!-- 更新消息状态为已读 -->
    <update id="updateMessageStatus">
        UPDATE chat_message
        SET messageStatus = 2,
            updateTime = NOW()
        WHERE senderId = #{senderId}
        AND receiverId = #{receiverId}
        AND messageStatus = 0
        AND isDeleted = 0
    </update>
    
</mapper>